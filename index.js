// curl "curl 'https://cmsweb.calpoly.edu/psc/CSLOPRD/EMPLOYEE/SA/c/SA_LEARNER_SERVICES.CLASS_SEARCH.GBL' -H 'Origin: https://cmsweb.calpoly.edu' -H 'Accept-Encoding: gzip, deflate, br' -H 'Accept-Language: en-US,en;q=0.9' -H 'User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/73.0.3683.86 Safari/537.36' -H 'Content-Type: application/x-www-form-urlencoded' -H 'Accept: */*' -H 'Referer: https://cmsweb.calpoly.edu/psc/CSLOPRD/EMPLOYEE/SA/c/SA_LEARNER_SERVICES.CLASS_SEARCH.GBL?Page=SSR_CLSRCH_ENTRY&Action=U&ExactKeys=Y&TargetFrameName=None' -H 'Cookie: SignOnDefault=ERQIAN; PS_DEVICEFEATURES=width:1536 height:864 pixelratio:1.25 touch:0 geolocation:1 websockets:1 webworkers:1 datepicker:1 dtpicker:1 timepicker:1 dnd:1 sessionstorage:1 localstorage:1 history:1 canvas:1 svg:1 postmessage:1 hc:0 maf:0; cssln716CSLO1-85513=nBDVLBVJnLnVMoXTeD2wqHP7U1QBUPIV!-310702582; ExpirePage=https://cmsweb.calpoly.edu/psp/CSLOPRD/; PS_LOGINLIST=https://cmsweb.calpoly.edu/CSLOPRD; PS_TOKEN=pAAAAAQDAgEBAAAAvAIAAAAAAAAsAAAABABTaGRyAk4AbQg4AC4AMQAwABQZvVAk3SspqO4Po8/Lwb9M6brxsWQAAAAFAFNkYXRhWHicHYpLDkBQEATLJ1biJl4wSCyFF5GI7znc0OE0s6juSs8NxFEYBMon5L/Uc3Iw07OSeGEiG7hY2Ni1jdQVBSUdudJEk329wamZ2MgcNZW+WpnBC206C0s=; https%3a%2f%2fcmsweb.calpoly.edu%2fpsp%2fcsloprd%2femployee%2fsa%2frefresh=list: %3ftab%3ddefault|%3frp%3ddefault|%3ftab%3dremoteunifieddashboard|%3frp%3dremoteunifieddashboard; ps_theme=node:SA portal:EMPLOYEE theme_id:SLO_THEME_TANGERINE accessibility:N formfactor:3 piamode:1; psback=%22%22url%22%3A%22https%3A%2F%2Fcmsweb.calpoly.edu%2Fpsc%2FCSLOPRD%2FEMPLOYEE%2FSA%2Fc%2FSA_LEARNER_SERVICES.CLASS_SEARCH.GBL%3FPage%3DSSR_CLSRCH_ENTRY%26Action%3DU%26ExactKeys%3DY%26TargetFrameName%3DNone%22%20%22label%22%3A%22zzz%22%20%22origin%22%3A%22PIA%22%20%22layout%22%3A%220%22%22; TS01efa3ea=012a549ad271a73136ef2e3be14dd3b08778fcaf002eeb3e70fc829c0353fcff95502ac11676b4bd0bf8cadef34a6ee46b827c3f8e; TS014709d1=012a549ad2f2720326ace68230af5adc47dfb4737a4f9c38bd8c1d0a516e6b67851f0e82d39eea730535e9f8332e239a5e37bb3930543647796bf707e73b83fe28f21d34c4c76ba656f8ae953b7e0c0166e68538eb49d5b3264fffe7efbfa4a15670193f2db6911a14c3b592dc9dca67396881e7dc662c2d90b56ebed028e6d83c7820479af6e6375115b76bb593b14cfd6fcc369e722589233eba7ce3f755db2e0c9dc632e558c531437fdb15f100f2e182b3cc5f; PS_TOKENEXPIRE=31_Mar_2019_19:28:25_GMT' -H 'Connection: keep-alive' -H 'DNT: 1' --data 'ICAJAX=1&ICNAVTYPEDROPDOWN=0&ICType=Panel&ICElementNum=0&ICStateNum=13&ICAction=CLASS_SRCH_WRK2_SSR_PB_CLASS_SRCH&ICModelCancel=0&ICXPos=0&ICYPos=102.4000015258789&ResponsetoDiffFrame=-1&TargetFrameName=None&FacetPath=None&ICFocus=&ICSaveWarningFilter=0&ICChanged=-1&ICAutoSave=0&ICResubmit=0&ICSID=3GrXt%2BE4TKgFwBb3p8E0DYkp09D3VEsryXbSuwiAsUU%3D&ICActionPrompt=false&ICBcDomData=UnknownValue&ICPanelName=&ICFind=&ICAddCount=&ICAPPCLSDATA=&DERIVED_SSTSNAV_SSTS_MAIN_GOTO$27$=9999&CLASS_SRCH_WRK2_INSTITUTION$31$=SLCMP&SLO_SS_DERIVED_STRM=2194&SSR_CLSRCH_WRK_SUBJECT_SRCH$0=CHEM&SSR_CLSRCH_WRK_SSR_EXACT_MATCH1$1=E&SSR_CLSRCH_WRK_CATALOG_NBR$1=&SSR_CLSRCH_WRK_ACAD_CAREER$2=&SSR_CLSRCH_WRK_SSR_OPEN_ONLY$chk$3=Y&SSR_CLSRCH_WRK_SSR_OPEN_ONLY$3=Y&ptus_defaultlocalnode=CSLOPRD&ptus_dbname=CSLOPRD&ptus_portal=EMPLOYEE&ptus_node=SA&ptus_workcenterid=&ptus_componenturl=https%3A%2F%2Fcmsweb.calpoly.edu%2Fpsp%2FCSLOPRD%2FEMPLOYEE%2FSA%2Fc%2FSA_LEARNER_SERVICES.CLASS_SEARCH.GBL' --compressed
// curl 'curl 'https://cmsweb.calpoly.edu/psc/CSLOPRD/EMPLOYEE/SA/c/SA_LEARNER_SERVICES.CLASS_SEARCH.GBL'
//  -H 'Origin: https://cmsweb.calpoly.edu' 
// -H 'Accept-Encoding: gzip, deflate, br' 
// -H 'Accept-Language: en-US,en;q=0.9' 
// -H 'User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/73.0.3683.86 Safari/537.36'
// -H 'Content-Type: application/x-www-form-urlencoded' 
// -H 'Accept: */*' 
// -H 'Referer: https://cmsweb.calpoly.edu/psc/CSLOPRD/EMPLOYEE/SA/c/SA_LEARNER_SERVICES.CLASS_SEARCH.GBL?Page=SSR_CLSRCH_ENTRY&Action=U&ExactKeys=Y&TargetFrameName=None' 
// -H 'Cookie: SignOnDefault=ERQIAN; PS_DEVICEFEATURES=width:1536 height:864 pixelratio:1.25 touch:0 geolocation:1 websockets:1 webworkers:1 datepicker:1 dtpicker:1 timepicker:1 dnd:1 sessionstorage:1 localstorage:1 history:1 canvas:1 svg:1 postmessage:1 hc:0 maf:0; cssln716CSLO1-85513=nBDVLBVJnLnVMoXTeD2wqHP7U1QBUPIV!-310702582; ExpirePage=https://cmsweb.calpoly.edu/psp/CSLOPRD/; PS_LOGINLIST=https://cmsweb.calpoly.edu/CSLOPRD; PS_TOKEN=pAAAAAQDAgEBAAAAvAIAAAAAAAAsAAAABABTaGRyAk4AbQg4AC4AMQAwABQZvVAk3SspqO4Po8/Lwb9M6brxsWQAAAAFAFNkYXRhWHicHYpLDkBQEATLJ1biJl4wSCyFF5GI7znc0OE0s6juSs8NxFEYBMon5L/Uc3Iw07OSeGEiG7hY2Ni1jdQVBSUdudJEk329wamZ2MgcNZW+WpnBC206C0s=; https%3a%2f%2fcmsweb.calpoly.edu%2fpsp%2fcsloprd%2femployee%2fsa%2frefresh=list: %3ftab%3ddefault|%3frp%3ddefault|%3ftab%3dremoteunifieddashboard|%3frp%3dremoteunifieddashboard; ps_theme=node:SA portal:EMPLOYEE theme_id:SLO_THEME_TANGERINE accessibility:N formfactor:3 piamode:1; psback=%22%22url%22%3A%22https%3A%2F%2Fcmsweb.calpoly.edu%2Fpsc%2FCSLOPRD%2FEMPLOYEE%2FSA%2Fc%2FSA_LEARNER_SERVICES.CLASS_SEARCH.GBL%3FPage%3DSSR_CLSRCH_ENTRY%26Action%3DU%26ExactKeys%3DY%26TargetFrameName%3DNone%22%20%22label%22%3A%22zzz%22%20%22origin%22%3A%22PIA%22%20%22layout%22%3A%220%22%22; TS01efa3ea=012a549ad271a73136ef2e3be14dd3b08778fcaf002eeb3e70fc829c0353fcff95502ac11676b4bd0bf8cadef34a6ee46b827c3f8e; TS014709d1=012a549ad2f2720326ace68230af5adc47dfb4737a4f9c38bd8c1d0a516e6b67851f0e82d39eea730535e9f8332e239a5e37bb3930543647796bf707e73b83fe28f21d34c4c76ba656f8ae953b7e0c0166e68538eb49d5b3264fffe7efbfa4a15670193f2db6911a14c3b592dc9dca67396881e7dc662c2d90b56ebed028e6d83c7820479af6e6375115b76bb593b14cfd6fcc369e722589233eba7ce3f755db2e0c9dc632e558c531437fdb15f100f2e182b3cc5f; PS_TOKENEXPIRE=31_Mar_2019_19:28:25_GMT'
// -H 'Connection: keep-alive' 
// -H 'DNT: 1' 
// --data 'ICAJAX=1&ICNAVTYPEDROPDOWN=0&ICType=Panel&ICElementNum=0&ICStateNum=13&ICAction=CLASS_SRCH_WRK2_SSR_PB_CLASS_SRCH&ICModelCancel=0&ICXPos=0&ICYPos=102.4000015258789&ResponsetoDiffFrame=-1&TargetFrameName=None&FacetPath=None&ICFocus=&ICSaveWarningFilter=0&ICChanged=-1&ICAutoSave=0&ICResubmit=0&ICSID=3GrXt%2BE4TKgFwBb3p8E0DYkp09D3VEsryXbSuwiAsUU%3D&ICActionPrompt=false&ICBcDomData=UnknownValue&ICPanelName=&ICFind=&ICAddCount=&ICAPPCLSDATA=&DERIVED_SSTSNAV_SSTS_MAIN_GOTO$27$=9999&CLASS_SRCH_WRK2_INSTITUTION$31$=SLCMP&SLO_SS_DERIVED_STRM=2194&SSR_CLSRCH_WRK_SUBJECT_SRCH$0=CHEM&SSR_CLSRCH_WRK_SSR_EXACT_MATCH1$1=E&SSR_CLSRCH_WRK_CATALOG_NBR$1=&SSR_CLSRCH_WRK_ACAD_CAREER$2=&SSR_CLSRCH_WRK_SSR_OPEN_ONLY$chk$3=Y&SSR_CLSRCH_WRK_SSR_OPEN_ONLY$3=Y&ptus_defaultlocalnode=CSLOPRD&ptus_dbname=CSLOPRD&ptus_portal=EMPLOYEE&ptus_node=SA&ptus_workcenterid=&ptus_componenturl=https%3A%2F%2Fcmsweb.calpoly.edu%2Fpsp%2FCSLOPRD%2FEMPLOYEE%2FSA%2Fc%2FSA_LEARNER_SERVICES.CLASS_SEARCH.GBL' 
// --compressed




// curl 'https://cmsweb.calpoly.edu/psc/CSLOPRD/EMPLOYEE/SA/c/SA_LEARNER_SERVICES.CLASS_SEARCH.GBL' 
// - H 'Origin: https://cmsweb.calpoly.edu' 
// - H 'Accept-Encoding: gzip, deflate, br' 
// - H 'Accept-Language: en-US,en;q=0.9' 
// - H 'User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/73.0.3683.86 Safari/537.36' 
// - H 'Content-Type: application/x-www-form-urlencoded' 
// - H 'Accept: */*' 
// - H 'Referer: https://cmsweb.calpoly.edu/psc/CSLOPRD/EMPLOYEE/SA/c/SA_LEARNER_SERVICES.CLASS_SEARCH.GBL?Page=SSR_CLSRCH_ENTRY&Action=U&ExactKeys=Y&TargetFrameName=None' 
// - H 'Cookie: SignOnDefault=ERQIAN; PS_DEVICEFEATURES=width:1536 height:864 pixelratio:1.25 touch:0 geolocation:1 websockets:1 webworkers:1 datepicker:1 dtpicker:1 timepicker:1 dnd:1 sessionstorage:1 localstorage:1 history:1 canvas:1 svg:1 postmessage:1 hc:0 maf:0; cssln716CSLO1-85513=nBDVLBVJnLnVMoXTeD2wqHP7U1QBUPIV!-310702582; ExpirePage=https://cmsweb.calpoly.edu/psp/CSLOPRD/; PS_LOGINLIST=https://cmsweb.calpoly.edu/CSLOPRD; PS_TOKEN=pAAAAAQDAgEBAAAAvAIAAAAAAAAsAAAABABTaGRyAk4AbQg4AC4AMQAwABQZvVAk3SspqO4Po8/Lwb9M6brxsWQAAAAFAFNkYXRhWHicHYpLDkBQEATLJ1biJl4wSCyFF5GI7znc0OE0s6juSs8NxFEYBMon5L/Uc3Iw07OSeGEiG7hY2Ni1jdQVBSUdudJEk329wamZ2MgcNZW+WpnBC206C0s=; https%3a%2f%2fcmsweb.calpoly.edu%2fpsp%2fcsloprd%2femployee%2fsa%2frefresh=list: %3ftab%3ddefault|%3frp%3ddefault|%3ftab%3dremoteunifieddashboard|%3frp%3dremoteunifieddashboard; ps_theme=node:SA portal:EMPLOYEE theme_id:SLO_THEME_TANGERINE accessibility:N formfactor:3 piamode:1; psback=%22%22url%22%3A%22https%3A%2F%2Fcmsweb.calpoly.edu%2Fpsc%2FCSLOPRD%2FEMPLOYEE%2FSA%2Fc%2FSA_LEARNER_SERVICES.CLASS_SEARCH.GBL%3FPage%3DSSR_CLSRCH_ENTRY%26Action%3DU%26ExactKeys%3DY%26TargetFrameName%3DNone%22%20%22label%22%3A%22zzz%22%20%22origin%22%3A%22PIA%22%20%22layout%22%3A%220%22%22; TS01efa3ea=012a549ad271a73136ef2e3be14dd3b08778fcaf002eeb3e70fc829c0353fcff95502ac11676b4bd0bf8cadef34a6ee46b827c3f8e; TS014709d1=012a549ad2f2720326ace68230af5adc47dfb4737a4f9c38bd8c1d0a516e6b67851f0e82d39eea730535e9f8332e239a5e37bb3930543647796bf707e73b83fe28f21d34c4c76ba656f8ae953b7e0c0166e68538eb49d5b3264fffe7efbfa4a15670193f2db6911a14c3b592dc9dca67396881e7dc662c2d90b56ebed028e6d83c7820479af6e6375115b76bb593b14cfd6fcc369e722589233eba7ce3f755db2e0c9dc632e558c531437fdb15f100f2e182b3cc5f; PS_TOKENEXPIRE=31_Mar_2019_19:28:25_GMT'
// - H 'Connection: keep-alive' 
// - H 'DNT: 1' 
// --data 'ICAJAX=1&ICNAVTYPEDROPDOWN=0&ICType=Panel&ICElementNum=0&ICStateNum=13&ICAction=CLASS_SRCH_WRK2_SSR_PB_CLASS_SRCH&ICModelCancel=0&ICXPos=0&ICYPos=102.4000015258789&ResponsetoDiffFrame=-1&TargetFrameName=None&FacetPath=None&ICFocus=&ICSaveWarningFilter=0&ICChanged=-1&ICAutoSave=0&ICResubmit=0&ICSID=3GrXt%2BE4TKgFwBb3p8E0DYkp09D3VEsryXbSuwiAsUU%3D&ICActionPrompt=false&ICBcDomData=UnknownValue&ICPanelName=&ICFind=&ICAddCount=&ICAPPCLSDATA=&DERIVED_SSTSNAV_SSTS_MAIN_GOTO$27$=9999&CLASS_SRCH_WRK2_INSTITUTION$31$=SLCMP&SLO_SS_DERIVED_STRM=2194&SSR_CLSRCH_WRK_SUBJECT_SRCH$0=CHEM&SSR_CLSRCH_WRK_SSR_EXACT_MATCH1$1=E&SSR_CLSRCH_WRK_CATALOG_NBR$1=&SSR_CLSRCH_WRK_ACAD_CAREER$2=&SSR_CLSRCH_WRK_SSR_OPEN_ONLY$chk$3=Y&SSR_CLSRCH_WRK_SSR_OPEN_ONLY$3=Y&ptus_defaultlocalnode=CSLOPRD&ptus_dbname=CSLOPRD&ptus_portal=EMPLOYEE&ptus_node=SA&ptus_workcenterid=&ptus_componenturl=https%3A%2F%2Fcmsweb.calpoly.edu%2Fpsp%2FCSLOPRD%2FEMPLOYEE%2FSA%2Fc%2FSA_LEARNER_SERVICES.CLASS_SEARCH.GBL' 
// --compressed

const http = require('https');
const request = require('request');
const colors = require('colors/safe');
const HTMLParser = require('node-html-parser');
const cron = require('cron');

const postData = 'ICAJAX=1&ICNAVTYPEDROPDOWN=0&ICType=Panel&ICElementNum=0&ICStateNum=13&ICAction=CLASS_SRCH_WRK2_SSR_PB_CLASS_SRCH&ICModelCancel=0&ICXPos=0&ICYPos=102.4000015258789&ResponsetoDiffFrame=-1&TargetFrameName=None&FacetPath=None&ICFocus=&ICSaveWarningFilter=0&ICChanged=-1&ICAutoSave=0&ICResubmit=0&ICSID=3GrXt%2BE4TKgFwBb3p8E0DYkp09D3VEsryXbSuwiAsUU%3D&ICActionPrompt=false&ICBcDomData=UnknownValue&ICPanelName=&ICFind=&ICAddCount=&ICAPPCLSDATA=&DERIVED_SSTSNAV_SSTS_MAIN_GOTO$27$=9999&CLASS_SRCH_WRK2_INSTITUTION$31$=SLCMP' + 
                '&SLO_SS_DERIVED_STRM=2194' +             // Term number
                '&SSR_CLSRCH_WRK_SUBJECT_SRCH$0=CHEM' +    // Subject Shortcode
                '&SSR_CLSRCH_WRK_SSR_EXACT_MATCH1$1=E' +  // Search exact match? E = exact
                '&SSR_CLSRCH_WRK_CATALOG_NBR$1=' +        // Catalog number
                '&SSR_CLSRCH_WRK_ACAD_CAREER$2=&SSR_CLSRCH_WRK_SSR_OPEN_ONLY$chk$3=Y&SSR_CLSRCH_WRK_SSR_OPEN_ONLY$3=Y&ptus_defaultlocalnode=CSLOPRD&ptus_dbname=CSLOPRD&ptus_portal=EMPLOYEE&ptus_node=SA&ptus_workcenterid=&ptus_componenturl=https%3A%2F%2Fcmsweb.calpoly.edu%2Fpsp%2FCSLOPRD%2FEMPLOYEE%2FSA%2Fc%2FSA_LEARNER_SERVICES.CLASS_SEARCH.GBL';
const DEBUG = true;
const DELAY = 5;
// const DELAY = 1;
var retryCt = 0;

const options = {
    hostname: 'cmsweb.calpoly.edu',
    port: 443,
    path: '/psc/CSLOPRD/EMPLOYEE/SA/c/SA_LEARNER_SERVICES.CLASS_SEARCH.GBL',
    method: 'POST',
    headers: {
        'Connection': 'keep-alive',
        'Cache-Control': 'max-age=0',
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/70.0.3538.102 Safari/537.36',
        'Origin': 'https://cmsweb.calpoly.edu',
        'DNT': '1',
        'Accept': '*/*',
        'Referer': 'https://cmsweb.calpoly.edu/psc/CSLOPRD/EMPLOYEE/SA/c/SA_LEARNER_SERVICES.CLASS_SEARCH.GBL?Page=SSR_CLSRCH_ENTRY^&Action=U^&ExactKeys=Y^&TargetFrameName=None',
        'Accept-Encoding': 'gzip, deflate, br',
        'Accept-Language': 'en-US,en;q=0.9',
        'Cookie': 'SignOnDefault=ERQIAN; PS_DEVICEFEATURES=width:1536 height:864 pixelratio:1.25 touch:0 geolocation:1 websockets:1 webworkers:1 datepicker:1 dtpicker:1 timepicker:1 dnd:1 sessionstorage:1 localstorage:1 history:1 canvas:1 svg:1 postmessage:1 hc:0 maf:0; cssln716CSLO1-85513=nBDVLBVJnLnVMoXTeD2wqHP7U1QBUPIV^!-310702582; ExpirePage=https://cmsweb.calpoly.edu/psp/CSLOPRD/; PS_LOGINLIST=https://cmsweb.calpoly.edu/CSLOPRD; PS_TOKEN=pAAAAAQDAgEBAAAAvAIAAAAAAAAsAAAABABTaGRyAk4AbQg4AC4AMQAwABQZvVAk3SspqO4Po8/Lwb9M6brxsWQAAAAFAFNkYXRhWHicHYpLDkBQEATLJ1biJl4wSCyFF5GI7znc0OE0s6juSs8NxFEYBMon5L/Uc3Iw07OSeGEiG7hY2Ni1jdQVBSUdudJEk329wamZ2MgcNZW+WpnBC206C0s=; https^%^3a^%^2f^%^2fcmsweb.calpoly.edu^%^2fpsp^%^2fcsloprd^%^2femployee^%^2fsa^%^2frefresh=list: ^%^3ftab^%^3ddefault^|^%^3frp^%^3ddefault^|^%^3ftab^%^3dremoteunifieddashboard^|^%^3frp^%^3dremoteunifieddashboard; TS01efa3ea=012a549ad2b79b0e66cd91a0fd089a7e6b3a4841d14f9c38bd8c1d0a516e6b67851f0e82d3fed67d43106287375aa5358dec5e818e; ps_theme=node:SA portal:EMPLOYEE theme_id:SLO_THEME_TANGERINE accessibility:N formfactor:3 piamode:1; ' + 
                    // The TS014709d1 changes?!
                    'TS014709d1=012a549ad2c778a6e04b37893881a46857227d11364f9c38bd8c1d0a516e6b67851f0e82d39eea730535e9f8332e239a5e37bb3930543647796bf707e73b83fe28f21d34c4c76ba656f8ae953b7e0c0166e68538ebc54764ccf15d81406b042c013457a6cf10d85d861a983ab046aa2bb4814908cd51a3512c7f03587fa14f9bcc1cd3daa713fd35439e51affaab1465cdfa3684097ee374f66ddca56a6b6781a89160ba788c781c15c8572588d57c7a97bfd49c20; ' + 
                    
                    'psback=^%^22^%^22url^%^22^%^3A^%^22https^%^3A^%^2F^%^2Fcmsweb.calpoly.edu^%^2Fpsc^%^2FCSLOPRD^%^2FEMPLOYEE^%^2FSA^%^2Fc^%^2FSA_LEARNER_SERVICES.CLASS_SEARCH.GBL^%^3FPage^%^3DSSR_CLSRCH_ENTRY^%^26Action^%^3DU^%^26ExactKeys^%^3DY^%^26TargetFrameName^%^3DNone^%^22^%^20^%^22label^%^22^%^3A^%^22zzz^%^22^%^20^%^22origin^%^22^%^3A^%^22PIA^%^22^%^20^%^22layout^%^22^%^3A^%^220^%^22^%^22; PS_TOKENEXPIRE=31_Mar_2019_19:15:51_GMT',
        'Content-Type': 'application/x-www-form-urlencoded',
        'Content-Length': Buffer.byteLength(postData)
    }
};

var req = http.request(options, (res) => {
    if (DEBUG) {
        console.log(`STATUS: ${res.statusCode}`);
        console.log(`HEADERS: ${JSON.stringify(res.headers)}`);
    }
    
    res.setEncoding('utf8');
    res.on('data', (chunk) => {
        if (DEBUG)
            console.log(`BODY: ${chunk}`);
        processHTML(chunk);
    });
    res.on('end', () => {
        if (DEBUG)
            console.log('No more data in response.');
        req.end();
    });
});

req.on('error', (e) => {
    console.error(`problem with request: ${e.message}`);
});



// write data to request body



try {
    // getSessionCookie();
    selfTest();
    initProg();
}
catch(err) {
    console.warn(err);
    alertERR(err);
}

function initProg() {

    var keepAlive = cron.job("30 6 * * *", function(){
        alertKeepAlive();
        console.info('Daily Keepalive email sent!');
    }); 
    
    var mainLogic = cron.job('0 */' + DELAY.toString() + ' * * * *', function(){
        var req = http.request(options, (res) => {
            if (DEBUG) {
                console.log(`STATUS: ${res.statusCode}`);
                console.log(`HEADERS: ${JSON.stringify(res.headers)}`);
            }
            
            res.setEncoding('utf8');
            res.on('data', (chunk) => {
                if (DEBUG)
                    console.log(`BODY: ${chunk}`);
                processHTML(chunk);
            });
            res.on('end', () => {
                if (DEBUG)
                    console.log('No more data in response.');
                req.end();
            });
        });

        req.write(postData);
        if (DEBUG)
            console.log("New req");
    }); 

    keepAlive.start();
    mainLogic.start();

}

function selfTest() {
    req.write(postData);
    alertKeepAlive();
    console.info("Start Up Test completed!");
    console.info("Delay Set: " + DELAY + " minute(s)");
}

function getSessionCookie() {
    //Does not work until we login directly to myportal
    var loginURL = 'https://ssb-prod.ec.fhda.edu/ssomanager/saml/login?relayState=%2Fc%2Fauth%2FSSB%3Fpkg%3Dhttps%3A%2F%2Fssb-prod.ec.fhda.edu%2FPROD%2Ffhda_uportal.P_DeepLink_Post%3Fp_page%3Dbwskfcls.p_sel_crse_search%26p_payload%3De30%3D'
    request(loginURL, function (error, response, body) {
        console.log('error:', error); // Print the error if one occurred
        console.log('statusCode:', response && response.statusCode); // Print the response status code if a response was received
        console.log('body:', body); // Print the HTML for the Google homepage.
    });
}
function processHTML (data) {
    const root = HTMLParser.parse(data);
    if (data.toString().includes("Session timeout occurred")) {
        retryCt++;
        console.log(colors.red("SESSION TIMEOUT\nAttempt: #" + (retryCt).toString()));
        console.log(colors.red(Date()));
        if (retryCt >= 3) {
            alertERR("SESSION TIMEOUT OCCURED");
            process.exit(1);
        }
        
    }
    root.querySelectorAll('tr').forEach(function(item, index) {
        if(index === 0) {
            var itemTarget = item.toString();
            if(itemTarget.includes('Jian Yu  Yu')) {
                if (DEBUG)
                    console.log("\n\n\n\n\n\n" + item + index );
                if(!itemTarget.includes('<td CLASS="dddefault">0</td>\n' + '<td CLASS="dddefault">Jian Yu  Yu (<ABBR title= "Primary">P</ABBR>)</td>')) {
                    alertIFTTT();
                }
                else {
                    console.log('Unavailable :( ' + Date());
                }
                if (DEBUG)
                    console.log("END OF PARSE\n\n\n\n\n\n")
            }
        }
        
      });
    // console.log(data);
}

function alertIFTTT() {
    // request.post(
    //     'https://maker.ifttt.com/trigger/classOpen/with/key/oaG31UULhfKGrvD6OoMM61Y08fHQEzPFlbO4qJJbWPk',
    //     { json: { value1: Date() } },
    //     function (error, response, body) {
    //         if (!error && response.statusCode == 200) {
    //             console.log(body);
    //             console.log(colors.bold('\n\n\n================='));
    //             console.log(colors.green(Date()));
    //             console.log(colors.green("OPEN SPACE FOUND!"));
    //             console.log(colors.bold('=================\n\n\n'));
    //         }
    //         else {
    //             console.err(colors.red("alertIFTTT() request failed!"));
    //         }
    //     }
    // );
}

function alertERR(err) {
    // request.post(
    //     'https://maker.ifttt.com/trigger/classErr/with/key/oaG31UULhfKGrvD6OoMM61Y08fHQEzPFlbO4qJJbWPk',
    //     { json: { value1: Date(), value2: err } },
    //     function (error, response, body) {
    //         if (!error && response.statusCode == 200) {
    //             console.log(err);
    //             console.log(body);
    //             console.error("PROGRAM EXCEPTION. Notification sent!");
    //             console.log(Date());
    //         }
    //         else {
    //             console.err(colors.red("alertERR() request failed!"));
    //         }
    //     }
    // );
}

function alertKeepAlive() {
    // request.post(
    //     'https://maker.ifttt.com/trigger/classReport/with/key/oaG31UULhfKGrvD6OoMM61Y08fHQEzPFlbO4qJJbWPk',
    //     { json: { value1: "Jian Yu  Yu" } },
    //     function (error, response, body) {
    //         if (!error && response.statusCode == 200) {
    //             // console.log(body);
    //             console.info("Daily KeepAlive Notification sent!");
    //             console.log(Date());
    //         }
    //         else {
    //             console.err(colors.red("alertKeepAlive() request failed!"));
    //         }
    //     }
    // );
}


if (process.platform === "win32") {
    var rl = require("readline").createInterface({
      input: process.stdin,
      output: process.stdout
    });
  
    rl.on("SIGINT", function () {
      process.emit("SIGINT");
    });
  }
  
  process.on("SIGINT", function () {
    //graceful shutdown
    console.log("Exiting...");
    req.end();
    process.exit();
  });
